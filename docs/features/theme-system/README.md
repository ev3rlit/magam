# 테마 시스템 PRD

## 1) 배경

Magam는 현재 색상/배경/텍스트 스타일이 컴포넌트 단위로 분산되어 있어, 라이트/다크 모드 전환과 브랜드 확장이 어렵다. 캔버스 기반 제품 특성상 대비(contrast)와 가독성은 작업 정확도에 직접 영향을 준다. 

이번 기능은 "일관된 토큰 기반 스타일링"을 도입해 다음을 달성한다.

- 사용자: 환경(낮/밤)에 맞는 안정적인 가독성
- 개발: 신규 UI 추가 시 색상 결정 비용 감소
- 제품: 향후 커스텀 테마/브랜드 테마로 확장 가능한 기반 확보

## 2) 문제 정의

현재 문제는 다음과 같다.

- 동일 의미 색상이 화면별로 다르게 정의됨 (예: 경계선/서브 텍스트)
- 다크 모드 대응 시 하드코딩 값 수정 범위가 큼
- 노드 선택/호버/에러 상태의 대비 기준이 문서화되어 있지 않음
- 시스템 설정(`prefers-color-scheme`)과 사용자 선택 충돌 정책이 없음

핵심 문제: "색상 체계가 코드와 UX 모두에서 단일 소스 오브 트루스(SSOT)로 관리되지 않는다."

## 3) 목표와 비목표

### 목표

- 라이트/다크 2개 공식 테마 제공
- CSS 변수 기반 토큰 체계(Primitive + Semantic) 정립
- 앱 재시작 없이 즉시 테마 전환
- 사용자 선택 테마 영속화(localStorage)
- 기본 접근성 대비 준수(텍스트/배경 최소 4.5:1)

### 비목표

- 사용자 임의 색상 편집 UI 제공
- 테넌트별 브랜딩(화이트라벨) 지원
- 고대비(High Contrast) 전용 테마 제공
- PDF/이미지 export 테마 커스터마이징

## 4) 사용자 시나리오

1. 사용자는 야간 작업 중 설정에서 "다크"를 선택한다.
2. 앱 전체(캔버스, 패널, 툴바, 모달, 상태 배지)가 즉시 다크 테마로 전환된다.
3. 브라우저를 닫았다가 다시 열어도 동일 테마가 유지된다.
4. 사용자가 "시스템"으로 바꾸면 OS 테마 변경 시 앱도 자동 반영된다.

보조 시나리오

- 신규 화면 추가 시 개발자는 하드코딩 색상 없이 의미 토큰만 사용해 일관된 UI를 구현한다.

## 5) 기능 요구사항

### FR-1 테마 모드

- 지원 모드: `light` | `dark` | `system`
- `system` 선택 시 `prefers-color-scheme`를 따라 동작

수용 기준

- [AC-1] 설정 UI에서 3개 모드를 선택할 수 있다.
- [AC-2] `system` 모드에서 OS 다크/라이트 변경 시 1초 이내 반영된다.

### FR-2 테마 적용 범위

- 적용 범위: 앱 셸, 캔버스 배경/그리드, 노드 기본 스타일, 패널, 버튼, 입력, 모달, 토스트
- 제외 범위: 사용자 콘텐츠 내부 임의 인라인 스타일

수용 기준

- [AC-3] 주요 공용 컴포넌트 100%가 semantic token을 사용한다.
- [AC-4] 하드코딩 HEX 색상 신규 추가가 CI 규칙으로 차단된다(예외 목록 제외).

### FR-3 영속화 및 초기화

- 사용자 선택값을 `localStorage.theme`에 저장
- 초기 로딩 우선순위: 사용자 선택 > 시스템 설정 > 기본값(light)

수용 기준

- [AC-5] 새로고침 후 테마가 유지된다.
- [AC-6] SSR/초기 렌더 시 플래시(FOUC)가 육안으로 감지되지 않는다.

### FR-4 접근성

- 텍스트/배경 대비 최소 4.5:1
- 비활성/보조 텍스트는 최소 3:1

수용 기준

- [AC-7] 핵심 화면 5개 이상에서 자동 대비 점검 통과
- [AC-8] 키보드 포커스 링이 두 테마에서 모두 명확히 식별 가능

### FR-5 개발자 가드레일

- 토큰 네이밍 규칙 문서화
- "primitive 직접 사용 금지, semantic 우선" 규칙 적용

수용 기준

- [AC-9] 디자인 토큰 문서에 각 semantic token의 사용 위치가 정의됨
- [AC-10] PR 템플릿 체크리스트에 테마 검증 항목 추가

## 6) 비기능 요구사항

- 성능: 테마 전환 시 인터랙션 블로킹 100ms 이하
- 안정성: 테마 전환으로 런타임 에러가 발생하지 않을 것
- 유지보수성: 신규 컴포넌트는 토큰만으로 테마 대응 가능해야 함
- 테스트성: 단위 테스트 + E2E로 모드 전환/영속화/시스템 추종 검증 가능해야 함

수용 기준

- [AC-11] 테마 토글 50회 반복 시 JS 에러 0건
- [AC-12] E2E에서 `light/dark/system` 3모드 회귀 테스트 통과

## 7) UX 제안

- 위치: 우상단 설정 메뉴 내 "테마" 섹션
- 옵션 라벨: `라이트`, `다크`, `시스템`
- 즉시 반영(Apply 버튼 없음)
- 현재 선택 모드에 체크 표시
- 첫 도입 시 1회만 툴팁 안내: "시스템 설정에 맞춰 자동 전환할 수 있어요"

상태 피드백

- 전환 시 별도 토스트는 생략(과도한 피드백 방지)
- 실패(저장 불가) 시에만 경고 토스트 노출

수용 기준

- [AC-13] 사용자는 2클릭 이내 테마 변경 가능
- [AC-14] 설정 메뉴를 벗어나도 변경 사항이 유지됨

## 8) 기술 설계 개요

### CSS 변수 전략

토큰 레이어를 2단으로 분리한다.

1. Primitive token: 실제 색상 값
2. Semantic token: UI 의미(배경, 텍스트, 경계선, 상태)

예시

```css
:root {
  /* Primitive */
  --color-gray-0: #ffffff;
  --color-gray-50: #f8fafc;
  --color-gray-900: #0f172a;
  --color-blue-500: #3b82f6;
  --color-red-500: #ef4444;

  /* Semantic (light default) */
  --bg-canvas: var(--color-gray-50);
  --bg-surface: var(--color-gray-0);
  --text-primary: var(--color-gray-900);
  --text-secondary: #475569;
  --border-default: #e2e8f0;
  --focus-ring: var(--color-blue-500);
  --state-danger: var(--color-red-500);
}

[data-theme='dark'] {
  /* Semantic override only */
  --bg-canvas: #020617;
  --bg-surface: #0f172a;
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e1;
  --border-default: #334155;
  --focus-ring: #60a5fa;
  --state-danger: #f87171;
}
```

운영 규칙

- 컴포넌트는 semantic token만 참조한다.
- primitive token은 테마 파일에서만 사용한다.
- 상태 색상(`success/warning/danger/info`)은 텍스트/배경 쌍으로 제공한다.

### 테마 결정 로직

- `ThemeProvider`에서 `mode(light|dark|system)`와 `resolvedTheme(light|dark)`를 분리 관리
- `system`일 때 `matchMedia('(prefers-color-scheme: dark)')` 구독
- `document.documentElement.dataset.theme = resolvedTheme`로 반영

### 테스트 포인트

- 단위: 모드 계산 우선순위, localStorage read/write
- 통합: 설정 UI 조작 시 DOM dataset 반영
- E2E: 새로고침/재접속/OS 테마 변경 시나리오

## 9) 단계별 구현 계획

1. 토큰 정리
- primitive/semantic 변수 정의 파일 추가
- 공통 색상 하드코딩 목록 추출

2. 인프라 구현
- `ThemeProvider` 및 `useTheme()` 구현
- 초기 부트스트랩 스크립트로 FOUC 최소화

3. UI 연결
- 설정 메뉴에 테마 선택 UI 추가
- 앱 셸/공용 컴포넌트를 semantic token으로 치환

4. 캔버스 영역 적용
- 캔버스 배경/그리드/선택 하이라이트 토큰 적용
- 노드 상태(선택/호버/비활성/에러) 토큰 정렬

5. 품질 보강
- 접근성 대비 점검
- E2E 회귀 테스트 추가
- 하드코딩 색상 lint 규칙 적용

릴리즈 기준

- AC-1 ~ AC-14 모두 충족
- 핵심 플로우(편집/선택/내보내기) 시각 회귀 없음

## 10) 성공 지표

- 테마 설정 사용률: 전체 활성 사용자 중 15% 이상이 비기본 모드 사용
- UI 색상 관련 버그: 릴리즈 후 4주 내 기존 대비 30% 이상 감소
- 테마 전환 체감 속도: 사용자 피드백에서 "느림" 리포트 5% 미만
- 개발 생산성: 신규 화면 PR에서 색상 리뷰 코멘트 감소 추세

## 11) 리스크 및 대응

- 리스크: legacy 컴포넌트에 하드코딩 색상이 남아 혼합 테마 발생
- 대응: lint + 마이그레이션 체크리스트 + 화면별 점검표 운영

- 리스크: `system` 모드에서 브라우저별 동작 차이
- 대응: Chromium/WebKit/Firefox 최소 버전 테스트 매트릭스 유지

- 리스크: 대비 기준 충족을 위해 브랜드 컬러 사용 범위 축소 필요
- 대응: brand color는 액션/강조에 제한하고 본문 텍스트에는 중립 계열 사용

## 12) 오픈 질문

- 다크 모드에서 캔버스 그리드 선명도 기준을 어디까지 허용할 것인가?
- 상태 색상(성공/경고/에러)의 채도 우선 vs 대비 우선 정책을 어떻게 고정할 것인가?
- 향후 커스텀 테마(팀 단위) 확장 시, semantic token 세트를 분리 파일로 관리할지 런타임 로딩으로 갈지?
- export 이미지가 현재 화면 테마를 따를지, 항상 라이트로 고정할지 제품 정책이 필요한가?
