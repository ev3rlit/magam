# 검색 기능 PRD (Magam)

## 1. 배경

Magam는 현재 파일 탐색(`Explorer`)과 캔버스 시각화 중심 UX를 제공하지만, 노드 수가 커질수록 원하는 항목을 빠르게 찾는 수단이 부족합니다.

현재 상태:

- 파일 선택은 트리 탐색 중심
- 캔버스 내 노드 탐색은 수동 줌/팬 중심
- `NavigationContext.navigateToNode`는 있으나 검색 UI와 연결되지 않음
- 로드맵에 검색 기능이 `planned`로 정의되어 있음

본 문서는 v1 검색 기능을 **UI/상태/내비게이션 중심으로 제품화**하기 위한 구현 기준을 정의합니다.

---

## 2. 문제 정의

사용자 관점 문제:

1. 노드가 많아지면 특정 ID/텍스트를 찾는 시간이 길다.
2. 파일 트리에서 파일명 탐색이 느리고 반복 클릭이 많다.
3. 검색 결과와 캔버스 포커스 이동이 연결되어 있지 않다.

제품 관점 문제:

1. 검색은 빠르게 동작해야 하며 기존 렌더/레이아웃 성능을 저해하면 안 된다.
2. 검색 상태(쿼리, 결과, 현재 포커스)가 전역 상태와 일관되게 동작해야 한다.
3. 키보드 중심 탐색(열기/이동/닫기) UX가 필요하다.

---

## 3. 목표와 비목표

### 목표 (Goals)

1. 노드/파일을 단일 검색 UI에서 즉시 찾는다.
2. 검색 결과 선택 시 캔버스 포커스 또는 파일 전환이 즉시 실행된다.
3. 검색어와 매칭된 노드를 시각적으로 하이라이트한다.
4. 1,000+ 노드에서도 체감 지연이 낮게 유지된다.

### 비목표 (Non-Goals)

1. 전체 프로젝트 텍스트 전문 검색(파일 본문 인덱싱)
2. 정규식/퍼지 고급 문법 지원
3. 서버 기반 분산 검색 인프라 구축

---

## 4. 사용자 시나리오

### 시나리오 A: 노드 검색 후 즉시 이동

1. 사용자가 `Cmd/Ctrl + K`로 검색창을 연다.
2. `auth`를 입력한다.
3. 결과 목록에서 `Node: auth.service`를 선택한다.
4. 캔버스가 해당 노드 중심으로 이동하고 노드가 하이라이트된다.

### 시나리오 B: 파일 검색 후 전환

1. 사용자가 검색창에 `overview.tsx`를 입력한다.
2. `File: docs/overview.tsx`를 선택한다.
3. 현재 파일이 전환되고 렌더 완료 후 검색창은 닫힌다.

### 시나리오 C: 키보드만으로 연속 탐색

1. 사용자가 검색창을 연다.
2. `↑/↓`로 결과를 이동한다.
3. `Enter`로 실행, `Esc`로 닫는다.

---

## 5. 기능 요구사항

| ID | 요구사항 | 수용 기준 (Acceptance Criteria) |
|---|---|---|
| FR-1 | 전역 검색 UI 제공 | `Cmd/Ctrl+K`로 검색 UI 열기/닫기가 동작하고, `Esc`로 닫힌다. |
| FR-2 | 검색 대상 통합 | 결과 목록에 `Node`와 `File` 타입이 모두 표시된다. |
| FR-3 | 노드 검색 필드 | 노드 검색은 `id`, `data.label`(markdown 포함 평문), `type` 기준으로 매칭된다. |
| FR-4 | 파일 검색 필드 | 파일 검색은 파일명 및 상대경로 기준으로 매칭된다. |
| FR-5 | 결과 정렬 규칙 | 동일 쿼리에서 `정확 일치 > 접두 일치 > 포함 일치` 순으로 정렬된다. |
| FR-6 | 결과 실행(노드) | 노드 결과 선택 시 해당 노드가 선택되고 캔버스가 해당 위치로 이동한다. |
| FR-7 | 결과 실행(파일) | 파일 결과 선택 시 `currentFile`이 변경되고 파일 렌더가 수행된다. |
| FR-8 | 실시간 하이라이트 | 쿼리 길이 2자 이상일 때 매칭 노드에 하이라이트 스타일이 표시된다. |
| FR-9 | 결과 없음 상태 | 매칭 결과가 없으면 빈 상태 메시지(`검색 결과 없음`)가 표시된다. |
| FR-10 | 상태 초기화 | 검색창 닫기 또는 쿼리 비움 시 하이라이트와 인덱스 포커스가 초기화된다. |

보조 규칙:

- v1 최소 쿼리 길이: 1자(하이라이트는 2자부터)
- 기본 최대 표시 개수: 30개
- 대소문자 비구분, 한글/영문 그대로 비교

---

## 6. 비기능 요구사항

| ID | 항목 | 기준 |
|---|---|---|
| NFR-1 | 응답 성능 | 1,000 노드 기준 입력 후 결과 갱신 p95 120ms 이하 (로컬 개발 환경) |
| NFR-2 | 렌더 안정성 | 검색 입력 중 ReactFlow 전체 재마운트가 발생하지 않는다. |
| NFR-3 | 접근성 | 검색 입력에 `aria-label`, 결과 리스트에 키보드 포커스/활성 상태가 제공된다. |
| NFR-4 | 회복성 | 파일 재렌더/WS 갱신 후에도 검색 상태가 크래시 없이 유지되거나 안전하게 초기화된다. |
| NFR-5 | 관측성 | 검색 실행 횟수/결과 수/실행 타입(node/file)을 디버그 로깅 가능하게 남긴다. |

---

## 7. UX 제안

핵심 UX:

1. 헤더 우측에 검색 트리거 버튼(`Search · ⌘K`)
2. 중앙 오버레이 검색 패널(결과 타입 배지: `Node`, `File`)
3. 결과 아이템에 매칭 하이라이트와 보조 텍스트(경로/노드 타입)
4. 하단 키 힌트: `↑↓ 이동`, `Enter 열기`, `Esc 닫기`

상태별 표현:

- 초기: 최근/추천 없음, 안내 문구만 표시
- 검색 중: 디바운스 이후 결과 리스트 갱신
- 결과 없음: 빈 상태 메시지 + 쿼리 유지
- 실행 완료: 패널 닫힘 + 토스트(예: `노드로 이동됨`)

---

## 8. 기술 설계 개요

### 8.1 변경 지점

- `app/store/graph.ts`: 검색 상태(`searchQuery`, `searchResults`, `activeResultIndex`, `highlightNodeIds`, `isSearchOpen`) 추가
- `app/components/ui/Header.tsx`: 검색 트리거/단축키 진입점 추가
- `app/components/GraphCanvas.tsx`: 하이라이트 노드 스타일 반영 및 포커스 이동 연결
- `app/contexts/NavigationContext.tsx`: 노드 이동 API 재사용
- 신규 `app/utils/search.ts`(또는 `app/hooks/useSearch.ts`): 인덱싱/매칭/정렬 로직 분리

### 8.2 데이터 흐름

1. `nodes`, `fileTree` 변경 시 검색 인덱스 재생성
2. 사용자 입력(`query`) -> 정규화 -> 점수 계산 -> 상위 30개 결과
3. 결과 선택:
   - `node`: `setSelectedNodes([nodeId])` + `navigateToNode(path)`
   - `file`: `setCurrentFile(filePath)`
4. 검색 상태 종료 시 하이라이트/포커스 상태 초기화

### 8.3 검색 스코어 (v1)

```text
score =
  100 (exact)
   70 (prefix)
   40 (contains)
 + 10 (id match bonus)
```

동점 시:

1. Node 우선
2. 문자열 길이 짧은 항목 우선
3. 사전순

### 8.4 테스트 범위

- 단위: `normalize`, `match`, `score`, `sort`
- 컴포넌트: 단축키, 결과 이동, 빈 상태
- 통합: 노드 선택 후 `setCenter` 호출 여부, 파일 전환 후 렌더 트리거

---

## 9. 단계별 구현 계획

### Phase 1: 검색 상태/로직 도입

- 스토어 검색 상태 및 액션 추가
- 검색 유틸(매칭/정렬/타입 모델) 구현
- 단위 테스트 작성

완료 기준:

- 스토어에서 쿼리 입력 시 결과 배열이 기대 순서로 생성된다.

### Phase 2: 검색 UI + 키보드 인터랙션

- 헤더 트리거, 오버레이 패널, 결과 리스트 구현
- `Cmd/Ctrl+K`, `↑/↓`, `Enter`, `Esc` 연결

완료 기준:

- 마우스 없이 검색 열기/선택/닫기 전 과정이 동작한다.

### Phase 3: 캔버스/파일 연동

- 노드 실행 시 선택/포커스 이동
- 파일 실행 시 전환 후 렌더 완료 확인
- 노드 하이라이트 스타일 적용/해제

완료 기준:

- 노드/파일 검색 모두 실행 후 기대 화면으로 이동한다.

### Phase 4: 성능/품질 마무리

- 디바운스/메모이제이션 튜닝
- 대규모 그래프(1,000 노드) 수동 성능 점검
- 접근성 라벨 및 회귀 테스트

완료 기준:

- NFR 성능/접근성 기준 충족.

---

## 10. 성공 지표

1. 검색 사용률: 활성 사용자 중 검색 기능 사용 비율 40% 이상
2. 탐색 시간: 특정 노드 도달 평균 시간 50% 이상 단축(기존 수동 탐색 대비)
3. 검색 성공률: 검색 실행 후 1회 내 원하는 항목 도달 비율 85% 이상
4. 성능: 입력-결과 갱신 p95 120ms 이하 유지
5. 오류율: 검색 실행 관련 JS 에러율 0.5% 미만

---

## 11. 리스크 및 대응

| 리스크 | 영향 | 대응 |
|---|---|---|
| 대규모 노드에서 입력 지연 | UX 저하 | 디바운스(100~150ms), 사전 정규화 캐시, 결과 상한 30개 |
| 하이라이트로 인한 렌더 비용 증가 | 프레임 드랍 | 하이라이트 대상 ID만 비교, 노드 컴포넌트 memo 유지 |
| 파일 전환 직후 포커스 불일치 | 혼란 | 파일 전환 후 렌더 완료 이벤트 기준으로 후속 포커스 처리 |
| 키보드 단축키 충돌 | 사용성 저하 | 입력 포커스/IME 조합 중 단축키 무시, 명시적 가드 추가 |

---

## 12. 오픈 질문

1. v1에서 검색 범위를 "현재 파일 노드 + 파일명"으로 제한할지, 다중 파일 노드까지 확장할지?
2. 파일 결과 선택 시 "즉시 이동"과 "미리보기 후 확정" 중 어떤 UX를 기본으로 할지?
3. 하이라이트 스타일을 선택 상태와 어떻게 구분할지(색상/테두리/애니메이션 정책)?
4. 검색 로그 수집을 로컬 디버그만 할지, 추후 텔레메트리 이벤트로 확장할지?
