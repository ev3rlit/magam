# Magam 탭 기능 PRD

## 1) 배경
현재 Magam는 페이지/캔버스 전환 비용이 높아, 여러 문맥(개요, 아키텍처, TODO)을 동시에 다루는 사용자가 작업 흐름을 자주 끊습니다. 탭 기반 탐색을 도입해 한 세션에서 여러 페이지를 빠르게 열고 닫을 수 있어야 합니다.

## 2) 문제 정의
- 페이지 전환 시 현재 작업 맥락(선택 상태, 뷰포트)이 자주 사라져 재탐색 비용이 큼
- 여러 페이지를 비교하면서 편집할 때 이동 클릭 수가 많음
- 키보드 중심 사용자에게 빠른 열기/닫기 동작이 없음

## 3) 목표와 비목표
### 목표
- 상단 탭 바에서 다중 페이지를 동시 관리
- 탭 열기/닫기 단축키 제공: `Cmd/Ctrl+T`, `Cmd/Ctrl+W`
- 탭 단위로 마지막 뷰포트/선택 상태 복원
- 기존 페이지 렌더링 구조를 크게 변경하지 않고 점진 도입

### 비목표
- 브라우저 수준 멀티 윈도우 동기화
- 실시간 협업 사용자별 탭 상태 동기화
- 탭 드래그 정렬(1차 릴리스 제외)

## 4) 사용자 시나리오
1. 사용자가 `overview`를 보다가 `architecture`를 빠르게 열기 위해 `Cmd/Ctrl+T`를 누른다.
2. 최근 페이지 목록(또는 페이지 선택 UI)에서 `architecture`를 선택하면 새 탭이 생성되고 즉시 활성화된다.
3. 사용자는 `overview` 탭과 `architecture` 탭을 번갈아 클릭하며 비교 편집한다.
4. 필요 없는 탭에서 `Cmd/Ctrl+W`를 눌러 닫는다.
5. 마지막 탭을 닫으면 기본 홈 페이지(또는 마지막 방문 페이지)로 안전하게 포커스 이동한다.

## 5) 기능 요구사항
### FR-1. 탭 바
- 상단 고정 탭 바 제공
- 각 탭 항목: 페이지명, dirty 표시(`●`), 닫기 버튼
- 활성 탭 시 시각적 강조

**Acceptance Criteria**
- 최소 1개 탭은 항상 활성 상태여야 한다.
- 동일 페이지를 중복으로 열지 않는다(기존 탭 활성화).
- 탭 제목은 페이지명과 동기화된다.

### FR-2. 탭 열기
- `Cmd/Ctrl+T` 입력 시 “페이지 열기” 동작 실행
- 페이지 선택 후 해당 페이지 탭 생성 및 활성화

**Acceptance Criteria**
- Mac에서 `Cmd+T`, Windows/Linux에서 `Ctrl+T` 동작이 동일하다.
- 이미 열린 페이지 선택 시 새 탭이 아니라 기존 탭으로 포커스 이동한다.
- 키 입력은 텍스트 입력 중일 때 무시된다(에디터 포커스 보호).

### FR-3. 탭 닫기
- 탭의 X 버튼 클릭 또는 `Cmd/Ctrl+W`로 활성 탭 닫기
- 더티 탭 닫기 시 확인 모달 표시(저장/취소/닫기)

**Acceptance Criteria**
- Mac에서 `Cmd+W`, Windows/Linux에서 `Ctrl+W` 동작이 동일하다.
- dirty=false 탭은 즉시 닫힌다.
- dirty=true 탭은 사용자 확인 전 닫히지 않는다.

### FR-4. 상태 복원
- 탭별 뷰포트(zoom/pan), 선택 상태를 메모리 캐시
- 탭 재활성화 시 마지막 상태 복원

**Acceptance Criteria**
- 탭 전환 후 100ms 이내 이전 뷰포트가 복원된다.
- 선택 요소가 삭제된 경우 선택 상태는 안전하게 초기화된다.

### FR-5. 탭 개수 제한
- 기본 최대 열린 탭 수: 10
- 제한 초과 시 가장 오래 비활성 탭부터 교체 여부 확인

**Acceptance Criteria**
- 11번째 탭 열기 시 안내 메시지를 표시한다.
- 사용자 취소 시 기존 탭 상태는 변경되지 않는다.

## 6) 비기능 요구사항
- 성능: 탭 전환 평균 150ms 이하(로컬 개발 기준)
- 안정성: 탭 전환/닫기 중 앱 크래시 0건
- 접근성: 탭 요소는 키보드 포커스 가능, `aria-selected`/`aria-controls` 제공
- 관측성: 탭 열기/닫기/전환 이벤트를 telemetry로 기록

## 7) UX 제안
- 레이아웃: 페이지 헤더 아래 수평 탭 바, 넘칠 때 좌우 스크롤
- 탭 우클릭 메뉴(1차 경량): `닫기`, `다른 탭 닫기`, `모두 닫기(저장 확인 포함)`
- 단축키 힌트는 페이지 열기 UI와 탭 툴팁에 노출
- dirty 상태는 텍스트 색보다 점(`●`)으로 명확히 표시

## 8) 기술 설계 개요
- 상태 모델
  - `openTabs: TabState[]` (`pageId`, `title`, `dirty`, `lastViewport`, `lastSelection`, `lastAccessedAt`)
  - `activeTabId: string`
- 액션
  - `openTab(pageId)`, `activateTab(tabId)`, `closeTab(tabId)`, `closeOtherTabs(tabId)`, `markTabDirty(tabId, dirty)`
- 단축키 레이어
  - 전역 키맵에서 `Cmd/Ctrl+T`, `Cmd/Ctrl+W` 등록
  - 입력 컴포넌트 포커스 시 처리 차단
- 라우팅/렌더링
  - URL 쿼리 또는 내부 상태로 활성 페이지 식별
  - 탭 전환 시 기존 캔버스 컴포넌트 재사용 + 탭별 UI 상태만 교체
- 저장 연계
  - dirty 플래그는 기존 저장 파이프라인 이벤트에서 갱신

## 9) 단계별 구현 계획
1. 탭 상태 스토어 추가
- 탭 타입 정의, 액션/셀렉터 구현
- 단위 테스트: open/close/activate/duplicate-open

2. 탭 바 UI 적용
- 상단 탭 컴포넌트 렌더링
- 클릭 전환, X 닫기, dirty 표시

3. 단축키 연결
- `Cmd/Ctrl+T`, `Cmd/Ctrl+W` 전역 바인딩
- 입력 포커스 예외 처리

4. 상태 복원 + 더티 가드
- 탭별 viewport/selection 캐시
- 더티 탭 닫기 확인 모달 연동

5. 제한/관측/폴리시 마감
- 탭 최대 개수 정책
- telemetry 이벤트 추가
- 회귀 테스트 및 QA 체크리스트 완료

## 10) 성공 지표
- 탭 기능 사용 세션 비율: 40% 이상
- 평균 페이지 전환 시간: 기존 대비 30% 이상 감소
- 사용자 액션당 페이지 이동 클릭 수: 20% 이상 감소
- 탭 관련 오류율(에러 이벤트): 1% 미만

## 11) 리스크 및 대응
- 단축키 충돌(브라우저 기본 동작)
  - 대응: 앱 포커스 영역에서만 핸들링하고 충돌 시 사용자 안내
- 메모리 증가(탭별 상태 캐시)
  - 대응: 탭 개수 제한 + 비활성 탭 경량 캐시
- 더티 상태 오검출
  - 대응: 저장 이벤트 기반 단일 소스에서 dirty 계산

## 12) 오픈 질문
- `Cmd/Ctrl+T` 실행 시 기본 동작은 “빈 탭 생성”인가, “페이지 선택기 즉시 오픈”인가?
- 마지막 탭 닫힘 시 도착 지점은 홈/최근 페이지 중 무엇이 맞는가?
- 탭 상태를 세션 간 복원(localStorage)까지 1차 범위에 포함할 것인가?
- 탭 최대 개수 10은 고정값인가, 설정 가능 옵션으로 열어둘 것인가?
